# Docker Build Test Workflow
# Verifies that Docker images build successfully and can run tests
# Based on L18 - CI/CD with Docker containers

name: Docker Build and Test

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'pyproject.toml'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Dockerfile'
      - 'pyproject.toml'

jobs:
  build-and-test:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t cheese-app-api:${{ github.sha }} .

      - name: Test Docker image - Start server
        run: |
          # Start the container as a server
          docker run -d --name test-api -p 9000:9000 -e DEV=1 cheese-app-api:${{ github.sha }}

          # Wait for startup
          sleep 10

          # Check if container is still running
          docker ps | grep test-api

          # Test root endpoint
          curl -f http://localhost:9000/ || exit 1

          echo "âœ… Docker image build and server startup successful!"

      - name: Show container logs
        if: always()
        run: docker logs test-api || true

      - name: Cleanup
        if: always()
        run: |
          docker stop test-api || true
          docker rm test-api || true
